---
title: 前端工程化实践
date: 2017-08-18 00:00
tags: [草稿,工程化,git,eslint]
---

# DTU前端工程化实践
年初入职TalkingData，到现在半年有余。感谢TD的充分信任和赋权，使我可以大胆尝试。整个部门几条产品线，如果技术栈、规范不统一，后期产品的迭代会很难进行下去。在组件化、git规范、代码规范和自动化方面引入了很多现成的方案。

## 组件化
如今的前端开发，已不是简单的页面制作加上jQuery，就能满足业务要求了。前端工程师要面对的不只是简单的网站，而是复杂的web应用。各产品需要更好的用户体验，团队选择了最为复杂的单页应用SPA，需要对代码质量有更高的要求，才能保证产品有好的体验。

### 各产品线统一为Vue技术栈
在前端框架领域，已是React、Angular和Vue三分天下，这些框架为前端组件化提供了很好的支持，团队选择使用Vue技术栈。
统一技术栈有很多好处，可以降低不同产品间人员调整的成本，可以在产品间共享组件和模块代码。

### 采用组件化的方式快速迭代产品
产品迭代的速度，很大程度上决定了产品成败。组件化的前端开发理念，可以快速的拼装出产品，每个组件都可以独立升级和替换。
前端组件是页面上可复用的UI单元，比如信息区块、页头、页尾、导航等。工程正式开发之前，我们仔细研究了设计图，统计出整个产品包含哪些组件，哪些组件可复用程度更高。
优先开发复用度更高的组件，完成后快速拼装出功能页面。不难想到，前端开发的效率取决于设计稿的完整度，设计师提供的设计稿越完整，前端工程师的开发效率会越高。
智能数据市场产品（SDMK）在开发初期，就选择了组件化的开发方式，很大的缩短了产品迭代周期。
(图片制作： 页面A --- 组件A --- 页面B)

## git规范化
团队中的几位工程师分工协作完成不同的功能组件，需要规范的代码管理流程，减少代码冲突和持续的功能集成。

### 规范化的git工作流
高效的开发团队，需要规范化的代码管理流程做保证，团队直接沿用了成熟的开发流程，并采用了每日集成的开发策略。

在产品开发阶段，每位工程师在自己开发分支下快速开发，每天在固定的时间，由组长将代码集成到daily分支。在集成的过程中，会进行CodeReview，检查代码规范和逻辑的部分。

完成集成后，执行Jenkins的构建过程。

产品上线后，进入功能迭代阶段，工程师的dev分支转换为feature分支。

每天完成计划的部分，定时集成到daily分支，并部署到daily环境。

大家每天的工作目标明确，成果可见，每天都很有成就感。

（图片：git工作流图）

### git提交规范
在每天构建的过程中，要对代码进行快速Review，一般会快速浏览gitlab中的提交记录，规范化的Commit message，为每天的Code Review提供了保证。

一次代码提交应该做到原子性：完成一个bug的修改、一个功能的文档、一次重构等等。

好的代码提交说明，应该完全匹配修改的内容，最好能够包含对修改的部分、类型给出明确的说明。

（gitlab截图：）

> fix(service):服务编辑时没有去掉可见性字段校验

我们直接引入了广泛使用的Angular提交规范，比较合理和系统化，并且有现成配套的工具。

（工具图片）

Angular规范：
```
feat：新功能（feature）
fix：修补bug
docs：文档（documentation）
style： 格式（不影响代码运行的变动）
refactor：重构（即不是新增功能，也不是修改bug的代码变动）
test：增加测试
chore：构建过程或辅助工具的变动
```
格式化的Commit message，有几个好处。

1. 提供更多的历史信息，方便代码CodeReview。
2. 可以过滤commit，快速查找信息。
3. 还可以由提交说明生成产品的changelog。

（Jenkins截图）

## 代码规范化
组建一只规范化的前端团队，是我转型技术管理第一目标：产品代码看起来像是是由一个人写的，代码和注释风格要统一。

### JavaScript的语言升级和规范化
过于灵活的ES5，并不适合企业级web应用开发。

由于产品存在历史代码，所以大家需要循序渐进的由ES5迁移到ES6下，比如新功能代码，禁止使用var声明变量，而改为使用let或const。

对于函数的声明，鼓励去掉function关键字，更多的使用箭头函数，尝试使用函数的默认值；

用模版字符串替换掉之前的字符串拼接；

逐渐深入使用ES6的更多的特性，整个迁移过程平滑自然。

在引入ES6语言的同时，引入了目前广泛使用和成熟的Airbnb语言规范，有现成的规

范文档。引入eslint工具，保证大家代码的规范性。在编辑和“编译”阶段，项目中引入相关eslint组件，自动检查代码的风格是否符合规范。

对不符合规范的代码，会给出错误提示，并不能执行代码。

大家在学习Airbnb的规范的同时，对照ES5和ES6的写法，快速完成语言的切换。

下面一段代码示例，实现数据的复制，可以发现ES6代码会更简洁高效。

```javascript
// bad
const len = items.length;
const itemsCopy = [];
let i;

for (i = 0; i < len; i += 1) {
  itemsCopy[i] = items[i];
}

// good
const itemsCopy = [...items];
```

### CSS预处理器SASS
样式预处理器SASS，为CSS带来了编程语言的能力，比如变量、函数和模块化。使用SASS能够很大程度上提高代码的复用度。

JavaScript有eslint检查工具，对于SASS可以使用stylelint检查代码，

遗憾的是社区开源的编辑器插件不是很完善，只找到了atom版本。

### HTMl的规范化
技术架构统一为Vue2.x，很遗憾没有找到Vue中HTML的规范化工具，后期会进行引入或研究开源。


## 组件化到模块化再到开源贡献
Vue的组件化能力，极大的缩短了产品开发周期，但回顾过去产品间的代码复用是不够的。
每个产品都有自己的一套time-format模块，不同产品线，重复劳动太多。

团队不仅仅需要组件化，我们需要将公共代码进行模块化，感谢Node社区。

各个产品引入了iView，减少了很多重复的劳动，为大家竖立了榜样。

希望团队成员都适度参与到开源社区的贡献，大家都是前端生态的一部分。

不止于业务，向前一步。

在完成功能开发后，多一些思考，想一下开发的功能其他开发者是不是有可能会用到。

## 源代码即文档
设计了声明式的model层，从代码中直观的看到接口协议，地址和参数规则等。
```
// define api
export const addInternalGroup = schema.post('/path/to/action', {
  name: { type: String, required: true },
  info: { type: String, required: true },
});

// use api
addInternalGroup({ name: 'xxx', info: 'xxx' }).then((json) => {
  log(json);  
});
```
开源了apischema https://www.npmjs.com/package/apischema

## 从前端到大前端之路

工程师要竖立前端大局观，从不同的角度考虑技术方案。

用前端的方案实现产品的灰度分流和配置。

基于koa2开源企业级Node解决方案Flclover，目前稳定在0.7.x版本，已经在内部两个项目完成了验证。

后期会优先在分析线落地。

## 最后
在前端工程化方面还有很长的路要走，持续学习和进步。

加油2017！
